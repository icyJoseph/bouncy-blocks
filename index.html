<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title></title>
    <link href="css/style.css" rel="stylesheet" />
  </head>
  <body>
    <canvas id="root"></canvas>

    <script>
      const FPS = 60;
      const fpsTime = 1000 / FPS; // ms

      const gravity = { current: 1 }; // pixel/frame
    </script>

    <script type="module">
      import init, { paint, update } from "./pkg/hello_wasm.js";

      const canvas = document.getElementById("root");

      const { width, height } = adjustCanvas();

      let state = [
        [0, 0, 0, 8, 1, 100, 255, 0, 0], // 0th
        [1, 0, 10, 4, 1, 200, 0, 255, 0], // 1st
        [2, 0, 20, 1, 1, 300, 0, 0, 255], // 2nd
      ]
        .reverse()
        .flat();

      init().then(() => {
        const context = canvas.getContext("2d");

        function loop(prev = 0) {
          requestAnimationFrame((timestamp) => {
            if (timestamp - prev < fpsTime) return loop(prev);

            const { width, height } = adjustCanvas();

            const pixels = paint(state, width, height);

            state = update(state, width, height, gravity.current);

            const imageData = new ImageData(pixels, width, height);

            context.putImageData(imageData, 0, 0);

            applyBackground(context, width, height);

            return loop(timestamp);
          });
        }

        loop();
      });

      function adjustCanvas() {
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;

        if (canvas.width !== width) {
          canvas.width = width;
        }

        if (canvas.height !== height) {
          canvas.height = height;
        }

        return { width: canvas.width, height: canvas.height };
      }

      function applyBackground(context, width, height) {
        context.globalCompositeOperation = "destination-over";
        context.fillStyle = "rgb(0,0,0,255)";
        context.fillRect(0, 0, width, height);
      }
    </script>

    <script type="module">
      navigator.mediaDevices
        .getUserMedia({ audio: true, video: false })
        .then((stream) => {
          const context = new AudioContext();
          const analyzer = context.createAnalyser();

          const source = context.createMediaStreamSource(stream);

          source.connect(analyzer);

          function collect(prev = 0) {
            requestAnimationFrame((timestamp) => {
              if (timestamp - prev < fpsTime) {
                return collect(prev);
              }

              analyzer.fftSize = 2048;
              const data = new Float32Array(analyzer.frequencyBinCount);

              analyzer.getFloatTimeDomainData(data);

              // Compute average power over the interval.
              const sumOfSquares = data.reduce(
                (acc, curr) => acc + curr * curr,
              );

              const avgPowerDecibels =
                10 * Math.log10(sumOfSquares / data.length);

              if (sumOfSquares > 30) {
                gravity.current = Math.max(-10, gravity.current - 1);
              } else if (gravity.current < 1) {
                gravity.current = Math.min(
                  1,
                  Math.ceil((gravity.current + 1) / 2),
                );
              }

              return collect(timestamp);
            });
          }

          collect();
        })
        .catch((reason) => {
          console.log(reason);
        });
    </script>
  </body>
</html>
