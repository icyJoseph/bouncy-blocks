<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bouncy Blocks</title>
    <link href="css/style.css" rel="stylesheet" />
  </head>
  <body>
    <canvas id="root"></canvas>

    <script>
      const FPS = 60;
      const fpsTime = 1000 / FPS; // ms

      const gravity = { current: 1 }; // pixel/frame

      const seen = new Set();

      let state = new Int32Array(9 * 1000);
    </script>

    <script type="module">
      import init, { paint, update } from "./pkg/bouncy_blocks.js";

      const canvas = document.getElementById("root");

      const { width, height } = adjustCanvas();

      init().then(() => {
        const context = canvas.getContext("2d");

        function loop(prev = 0) {
          requestAnimationFrame((timestamp) => {
            if (timestamp - prev < fpsTime) return loop(prev);

            const { width, height } = adjustCanvas();

            const pixels = paint(state, width, height);

            state = update(state, width, height, gravity.current);

            const imageData = new ImageData(pixels, width, height);

            context.putImageData(imageData, 0, 0);

            applyBackground(context, width, height);

            return loop(timestamp);
          });
        }

        loop();
      });

      function adjustCanvas() {
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;

        if (canvas.width !== width) {
          canvas.width = width;
        }

        if (canvas.height !== height) {
          canvas.height = height;
        }

        return { width: canvas.width, height: canvas.height };
      }

      function applyBackground(context, width, height) {
        context.globalCompositeOperation = "destination-over";
        context.fillStyle = "rgb(0,0,0,255)";
        context.fillRect(0, 0, width, height);
      }
    </script>

    <script type="module">
      navigator.mediaDevices
        .getUserMedia({ audio: true, video: false })
        .then((stream) => {
          const context = new AudioContext();
          const analyzer = context.createAnalyser();

          const source = context.createMediaStreamSource(stream);

          source.connect(analyzer);

          function collect(prev = 0) {
            requestAnimationFrame((timestamp) => {
              if (timestamp - prev < fpsTime * 2) return collect(prev);

              analyzer.fftSize = 256;
              analyzer.minDecibels = -60;

              const data = new Uint8Array(analyzer.frequencyBinCount);

              analyzer.getByteFrequencyData(data);

              const accPower = data.reduce((acc, curr) => acc + curr / 255, 0);

              if (accPower > 5) {
                gravity.current = Math.max(-10, gravity.current - 1);
              } else if (gravity.current < 1) {
                gravity.current = Math.min(
                  1,
                  Math.ceil((gravity.current + 1) / 2),
                );
              }

              return collect(timestamp);
            });
          }

          collect();
        })
        .catch((reason) => {
          console.log(reason);
        });
    </script>

    <script type="module">
      function getRandomInt(min, max) {
        const minCeiled = Math.ceil(min);
        const maxFloored = Math.floor(max);
        return Math.floor(Math.random() * (maxFloored - minCeiled) + minCeiled); // The maximum is exclusive and the minimum is inclusive
      }

      window.addEventListener("click", (event) => {
        const size = 100;

        const x = event.clientX;
        const y = event.clientY;

        const dx = getRandomInt(-2, 3);
        const dy = 0;

        const r = Math.floor(256 * Math.random());
        const g = Math.floor(256 * Math.random());
        const b = Math.floor(256 * Math.random());

        const id = seen.size;
        const block = [id, x, y, dx, dy, size, r, g, b];

        state.set(block, id * 9);

        seen.add(block);
      });
    </script>
  </body>
</html>
